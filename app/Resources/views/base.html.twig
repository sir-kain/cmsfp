<!DOCTYPE html>
<html lang="fr">

<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">

    <title>Centre Medico-Social</title>
    <link rel="icon" type="image/x-icon" href="{{ asset('favicon.png') }}"/>
    <link href="https://fonts.googleapis.com/css?family=Montserrat" rel="stylesheet">
    <!-- Bootstrap Core CSS -->
    <link href="{{ asset('templates/vendor/bootstrap/css/bootstrap.min.css') }}" rel="stylesheet">

    <!-- MetisMenu CSS -->
    <link href="{{ asset('templates/vendor/metisMenu/metisMenu.min.css') }}" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="{{ asset('templates/dist/css/sb-admin-2.css') }}" rel="stylesheet">

    <!-- Morris Charts CSS -->
    <link href="{{ asset('templates/vendor/morrisjs/morris.css') }}" rel="stylesheet">

    <!-- Custom Fonts -->
    <link href="{{ asset('templates/vendor/font-awesome/css/font-awesome.min.css') }}" rel="stylesheet" type="text/css">
    <link href="https://fonts.googleapis.com/css?family=Sacramento" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Merriweather" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Courgette|Merriweather" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css?family=Courgette|Indie+Flower|Merriweather" rel="stylesheet">
    <!--Datatables-->
    <link href="{{ asset('templates/vendor/datatables/css/dataTables.bootstrap.min.css') }}" rel="stylesheet"
          type="text/css">

    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/css/bootstrap-select.min.css">

    <!-- DATEPICKER CSS -->
    <link rel="stylesheet" type="text/css" href="{{ asset('templates/dist/css/bootstrap-datepicker3.css') }}">
    <link rel="stylesheet" type="text/css" href="{{ asset('templates/dist/css/bootstrap-datepicker.standalone.css') }}">
    <link rel="stylesheet" href="{{ asset('templates/dist/css/bootstrap-datetimepicker.min.css') }}">
    <link rel="stylesheet" href="{{ asset('templates/dist/css/ourStyle.css') }}">
    {#<link rel="stylesheet" href="{{ asset('templates/dist/css/widget.css') }}">#}
    <link rel="stylesheet" href="{{ asset('templates/tagsinput/bootstrap-tagsinput.css') }}">
    <link rel="stylesheet" href="{{ asset('templates/dist/css/select2/select2-bootstrap.css') }}">
    <link rel="stylesheet" href="{{ asset('templates/dist/css/select2/select2.css') }}">
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
    <script src="{{ asset('https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js') }}"></script>
    <script src="{{ asset('https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js') }}"></script>
    <![endif]-->
</head>

<body>
<div id="wrapper okko">
    {% block header %} {% endblock %}
    {% block fos_user_content %}{% endblock fos_user_content %}
    {% block body %} {% endblock %}
</div>
<!-- /#wrapper -->

<!-- jQuery -->
<script src="{{ asset('templates/vendor/jquery/jquery.min.js') }}"></script>

<!-- jQuery datatable -->
<script src="{{ asset('templates/vendor/datatables/js/jquery.dataTables.min.js') }}"></script>

<!-- Bootstrap Core JavaScript -->
<script src="{{ asset('templates/vendor/bootstrap/js/bootstrap.min.js') }}"></script>

<!-- Metis Menu Plugin JavaScript -->
<script src="{{ asset('templates/vendor/metisMenu/metisMenu.min.js') }}"></script>

<!-- Morris Charts JavaScript -->
<script src="{{ asset('templates/vendor/raphael/raphael.min.js') }}"></script>
<script src="{{ asset('templates/vendor/morrisjs/morris.min.js') }}"></script>
<script src="{{ asset('templates/data/morris-data.js') }}"></script>

<!-- Custom Theme JavaScript -->
<script src="{{ asset('templates/dist/js/sb-admin-2.js') }}"></script>

<!-- dataTablesJavaScript -->
<script src="{{ asset('templates/vendor/datatables/js/dataTables.bootstrap.min.js') }}"></script>

<!-- sweetAlert -->
<script src="{{ asset('templates/js/sweetalert.min.js') }}"></script>
<!-- datepicker -->
<script src="{{ asset('templates/dist/js/bootstrap-datepicker.min.js') }}"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-select/1.12.4/js/bootstrap-select.min.js"></script>
<script src="{{ asset('templates/dist/js/moment.js') }}"></script>
<script src="{{ asset('templates/dist/js/fr.js') }}"></script>
<script src="{{ asset('templates/dist/js/bootstrap-datetimepicker.js') }}"></script>
<script src="{{ asset('templates/tagsinput/bootstrap-tagsinput.min.js') }}"></script>
<script src="{{ asset('templates/dist/js/typeahead.bundle.js') }}"></script>
<script src="{{ asset('templates/dist/js/jquery.masked-input.min.js') }}"></script>
<script src="{{ asset('templates/dist/js/select2/select2.min.js') }}"></script>
{#<script src="{{ asset('bundles/fosjsrouting/js/router.min.js') }}"></script>#}
{#<script src="{{ path('fos_js_routing_js', { callback: 'fos.Router.setData' }) }}"></script>#}
{#<script src="{{ asset('templates/js/main.js') }}"></script>#}

<script>

    $(document).ready(function () {

        // typehead
        // constructs the suggestion engine
        var pathologies = new Bloodhound({
            prefetch: "../../../tags.json",
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('nom'),
            queryTokenizer: Bloodhound.tokenizers.whitespace
            // `states` is an array of state names defined in "The Basics"
//            local: states
        });

        $('.tag-input').tagsinput({
            typeaheadjs:
                [{
//                    hint: true,
                    highlight: true,
//                    minLength: 1
                },
                    {
                        name: 'nom',
                        display: 'nom',
                        value: 'nom',
                        source: pathologies
                    }]
        });


        //pour type exam
        // typehead
        // constructs the suggestion engine
        var typeexam = new Bloodhound({
            prefetch: "../../../typeexam.json",
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('nomTypeExamen'),
            queryTokenizer: Bloodhound.tokenizers.whitespace
            // `states` is an array of state names defined in "The Basics"
//            local: states
        });
        $('.tag-input-type').tagsinput({
            typeaheadjs:
                [{
//                    hint: true,
                    highlight: true,
//                    minLength: 1
                },
                    {
                        name: 'nomTypeExamen',
                        display: 'nomTypeExamen',
                        value: 'nomTypeExamen',
                        source: typeexam
                    }]
        });

//    affichage des champs statuts et Matricules pour les agents
        // select
        $("#typePatient").change(function () {
            // alert($("#decision").val() );
            if ($("#typePatient").val() == '2') {
                $('#selectstruc').val(null);
                $('#statutPatient').hide();
                $('#structure').hide();
                $('#matriculePatient').hide();
                $('#matricule').val('neant');
                $('#statut').val('neant');
            } else {
                $('#statutPatient').show();
                $('#matriculePatient').show();
                $('#structure').show();
                $('#matricule').val('');
                $('#statut').val('');
            }
        });

        $(".datepicker").datepicker({
            regional: 'fr',
            dateFormat: 'dd-MM-yyyy'
        });
        $('#rdv').datetimepicker({
            locale: 'fr',
            minDate: new Date()
        });
//            $(".datepickerRDV").datepicker({
//                regional: 'fr',
//                dateFormat: 'dd/MM/yyyy HH:mm'
//            });
        $("#dataTables-example").dataTable();
        $("#dataTables-example-utilisateur").dataTable();
        //"suppression service en ajax :)
        $(".btn-delete-service").click(function (event) {

            //
            event.preventDefault(); //Annuler l'action par défaut

            var boutton = $(event.target).closest('button');
            var id = $(boutton).attr('data-id');
            var message = $(boutton).data('confirm');
            //afficher la popup SweetAlert
            swal({
                title: "Êtes-vous sûr?",
                text: message, //Utiliser la valeur de data-confirm comme text
                icon: "warning",
                dangerMode: true,
                buttons: true,
                cancel: {
                    text: "Cancel",
                    value: null,
                    visible: false,
                    className: "",
                    closeModal: true,
                },
                confirm: {
                    text: "OK",
                    value: true,
                    visible: true,
                    className: "",
                    closeModal: true
                }
            }).then(function (willDelete) {
                    if (willDelete) {
                        //swal("Deleted!", "Your imaginary file has been deleted!", "success");

                        var url = "{{ path('deleteservice', {id:0}) }}";
                        $.ajax({
                            url: url.replace("0", id),
                            type: "delete",
                            data: {
                                action: 'deleteservice',
                                id: id
                            },
                            dataType: 'json',
                            success: function (data) {
                                $.each(data, function (item, value) {
                                    if (value === 'ok') {
                                        $(boutton).closest('tr').fadeOut(500, function () {
                                            $(this).remove();
                                        });
                                    }
                                });
                            },
                            error: function (x, y, z) {
                                alert(x + ' ' + y + ' ' + z);
                            }
                        });
                    }
                }
            )
            ;
            //----------------------
        });

        //"suppression medicament en ajax :)
        $(".btn-delete-medicament").click(function (event) {

            //
            event.preventDefault(); //Annuler l'action par défaut

            var boutton = $(event.target).closest('button');
            var id = $(boutton).attr('data-id');
            var message = $(boutton).data('confirm');
            //Afficher la popup SweetAlert
            swal({
                title: "Êtes-vous sûr?",
                text: message, //Utiliser la valeur de data-confirm comme text
                icon: "warning",
                dangerMode: true,
                buttons: true,
                cancel: {
                    text: "Cancel",
                    value: null,
                    visible: false,
                    className: "",
                    closeModal: true,
                },
                confirm: {
                    text: "OK",
                    value: true,
                    visible: true,
                    className: "",
                    closeModal: true
                }
            }).then(function (willDelete) {
                    if (willDelete) {
                        //swal("Deleted!", "Your imaginary file has been deleted!", "success");

                        var url = "{{ path('deletemedicament', {id:0}) }}";
                        $.ajax({
                            url: url.replace("0", id),
                            type: "delete",
                            data: {
                                action: 'deletemedicament',
                                id: id
                            },
                            dataType: 'json',
                            success: function (data) {
                                console.log('data', data)
                                $.each(data, function (item, value) {
                                    if (value === 'ok') {
                                        $(boutton).closest('tr').fadeOut(500, function () {
                                            $(this).remove();
                                            location.reload();
                                        });
                                    }
                                });
                            },
                            error: function (x, y, z) {
                                alert(x + ' ' + y + ' ' + z);
                            }
                        });
                    }
                }
            )
            ;
            //----------------------
        });

        // select
        $("#decision").change(function () {
            // alert($("#decision").val() );
            if ($("#decision").val() === 'RDV') {
                $('#daterdv').show();
            } else {
                $('#daterdv').hide();
            }
        });

        // select
        $("#typeantecedent").change(function () {
            // alert($("#decision").val() );
            if ($("#typeantecedent").val() === '2') {
                $('#allergies').hide();
                $('#traitements').hide();
                $('#chirurgicaux').hide();
            } else {
                $('#allergies').show();
                $('#traitements').show();
                $('#chirurgicaux').show();
            }
        });


        $("#messageOrdonnance").hide();
        $('#messageSuccess').hide();
        $('#messageError').hide();
        var nbMedic = 0;
        //"Affichage PopUp pour l'ajout de medicament
        $("#addMedic").click(function (event) {

            event.preventDefault(); //Annuler l'action par défaut
            var boutton = $(event.target).closest('button');
            var id = $(boutton).attr('data-id');
            var medicSelected = $("#medicSelected").val();
            var url = "{{ path('ordonnance_new') }}";
            var quantite = $("#quantite").val();
            var indication = $("#indication option:selected").text();
            var unite = $("#unite").val();
            console.log('unite', unite)
            console.log('unite', indication)
            if (quantite !== 'Choisissez la quantité' && indication !== 'Posologie' &&
                medicSelected !== '') {
                $.ajax({
                    url: url,
                    type: "POST",
                    data: {
                        id: id,
                        action: 'new',
                        idMedoc: medicSelected,
                        quantite: quantite,
                        unite: unite,
                        indication: indication
                    },
                    dataType: 'json',
                    success: function (data) {
                        $.each(data, function (item, value) {
                            if (value === 'ok') {
                                $("#quantite").val('0');
                                $("#unite").val('0');
                                $("#indication").val('0');
                                $("#medicSelected").val('');
                                $('#messageSuccess').show();
                                $('#messageSuccess').fadeOut(3500);
                            }
                            if (item === 'newMedic') {

                                nbMedic++;
                                $('#medicamentList')
                                    .append(`
                                        <li class="list-group-item ordonnanc">
                                        ${value.medic} ${value.indication}  ${value.quantite} prise(s) ${value.unite} unité(s)
                                        <button type="button" data-id="${value.ordonnance_id}"
                                        data-confirm="Voulez-vous supprimer le medicament?"
                                        class="fa fa-trash pull-right btn btn-danger btn-outline delete-medic"></button>
                                        </li>
                                    `)
                            }
                        });
                    },
                    error: function (x, y, z) {
                        alert(x + ' ' + y + ' ' + z);
                    }
                });
            } else {
                $('#messageError').show();
                $('#messageError').fadeOut(5000);
            }
        });

        //"suppression un medicament d'une ordonnance en ajax :)
        $('body').on('click', '.delete-medic', function (event) {
            //
            event.preventDefault(); //Annuler l'action par défaut

            var button = $(event.target).closest('button');

            var id = $(button).attr('data-id');
            var message = $(button).data('confirm');
            console.log('ko', button, id, message);
            //Afficher la popup SweetAlert
            swal({
                title: "Êtes-vous sûr?",
                text: message, //Utiliser la valeur de data-confirm comme text
                icon: "warning",
                dangerMode: true,
                buttons: true,
                cancel: {
                    text: "Cancel",
                    value: null,
                    visible: false,
                    className: "",
                    closeModal: true,
                },
                confirm: {
                    text: "OK",
                    value: true,
                    visible: true,
                    className: "",
                    closeModal: true
                }
            }).then(function (willDelete) {
                    if (willDelete) {
                        //swal("Deleted!", "Your imaginary file has been deleted!", "success");

                        var url = "{{ path('ordonnance_delete', {id:0}) }}";
                        $.ajax({
                            url: url.replace("0", id),
                            type: "delete",
                            data: {
                                action: 'deletemedic',
                                id: id
                            },
                            dataType: 'json',
                            success: function (data) {
                                console.log('data', data)
                                $.each(data, function (item, value) {
                                    if (value === 'ok') {
                                        $(button).closest('li').fadeOut(500, function () {
                                            $(this).remove();
                                        });
                                    }
                                });
                            },
                            error: function (x, y, z) {
                                alert(x + ' ' + y + ' ' + z);
                            }
                        });
                    }
                }
            )
            ;
            //----------------------
        });

        var medicaments = new Bloodhound({
            prefetch: "../../../medicaments.json",
            datumTokenizer: Bloodhound.tokenizers.obj.whitespace('nomMedicament'),
            queryTokenizer: Bloodhound.tokenizers.whitespace
            // `states` is an array of state names defined in "The Basics"
//            local: states
        });

        $('.tag-input-medic').typeahead({
                highlight: true
            },
            {
                name: 'nomMedicament',
                display: 'nomMedicament',
                value: 'nomMedicament',
                source: medicaments
            });
        if (window.location.href.includes('detailpatient/')) {
            var arrayUrl = window.location.href.split('/');
            var id = arrayUrl[arrayUrl.length - 1];
//        console.log(window.location.href.split('/'));
//        console.log(window.location.href.split('/').length);
            var urlp = "{{ path('getterrain', {id:0}) }}";
            $.ajax({
                url: urlp.replace("0", id),
                type: "post",
                data: {
                    action: 'getterrain'
                },
                dataType: 'json',
                success: function (data) {
                    $.each(data, function (item, value) {
                        if (value === 'ok') {
                            if (data.terrain !== null) {
                                swal({
                                    title: "Le patient est " + data.terrain,
                                    icon: "warning",
                                    showCancelButton: true,
                                    confirmButtonClass: "btn-danger",
                                    confirmButtonText: "ok!",
                                    closeOnConfirm: false
                                });
                            }
                        }
                    });
                },
                error: function (x, y, z) {
                    alert(x + ' ' + y + ' ' + z);
                }
            });
        }


        $("#numerodossierpatient").change(function () {
            if ($("#numerodossierpatient").val() !== "") {
                var numerodossierpatient = $("#numerodossierpatient").val();
                var url = "{{ path('getpatient') }}";
                $.ajax({
                    url: url,
                    data: {
                        action: "getpatient",
                        numerodossierpatient: numerodossierpatient
                    },
                    type: "POST",
                    dataType: "json",
                    success: function (data) {
                        $.each(data, function (item, valeur) {

                            if (data.output === 'ok') {
                                $("#tp").val(data.typepatient);
                                $("#np").val(data.nom);
                                $("#te").val("");
                                $("#pr").val('');
                            } else {
                                $("#tp").val("");
                                $("#np").val("");
                                $("#te").val('');
                                $("#pr").val('');
                            }

                        });

                    },
                    error: function (x, y, z) {
                        alert(x + ' ' + y + ' ' + z);
                    }

                });
            }
        });

        $("#te").change(function () {
            if ($("#te").val() !== "") {
                if ($("#tp").val() !== '') {
                    $('#patientrequis').hide();
                    var te = $("#te").val();
                    console.log(te)
                    var url = "{{ path('gettypeexamen') }}";
                    $.ajax({
                        url: url,
                        data: {
                            action: "gettypeexamen",
                            te: te
                        },
                        type: "POST",
                        dataType: "json",
                        success: function (data) {
                            // $.each(data, function (item, valeur) {
                            console.log(data)
                            if (data.output === 'ok') {
                                $('#createnewexamens').attr('data-idte', te);
                                // $('#createnewexamens').attr('data-listechampsid', data.champs);
                                $('#createnewexamens').attr('data-matriculepatient', $('#numerodossierpatient').val());
                                $("#resultsection").children("div").remove();
                                data.champs.forEach(function (element) {
                                    if (element.valeurminf == null) {
                                        $('#resultsection').append(`
                                    <div class="col-md-6">
                                        <div class="form-group">
                                            <label for="${element.id}"> ${element.libelle} </label>
                                            <input required="true" type="text" class="form-control" id="${element.id}"
                                            placeholder="${element.valeurmin} <> ${element.valeurmax} (${element.unite})">
                                        </div>
                                    </div>
                                        `);
                                    } else {

                                        $('#sectionResultat')
                                            .append(`
                                                <div class="form-group">
                                                    <label for="${element.id}"> ${element.libelle} </label>
                                                    <input required="true" type="text" class="form-control" id="${element.id}"
                                                    placeholder="Homme ${element.valeurmin} <> ${element.valeurmax} (${element.unite})
                                                    Femme ${element.valeurminf} <> ${element.valeurmaxf} (${element.unite})">
                                                </div>
                                            `)
                                    }
                                });
                                if ($('#tp').val() === 'Ayant droit') {
                                    $("#pr").val(data.prix - (data.prix * 0.8));
                                } else {
                                    $("#pr").val(data.prix);
                                }

                            } else {
                                $('#createnewexamens').attr('data-idte', null);
                                $('#createnewexamens').attr('data-listechampsid', null);
                                $('#createnewexamens').attr('data-matriculepatient', null);
                                $("#pr").val("");
                            }

                            // });
                        },
                        error: function (x, y, z) {
                            alert(x + ' ' + y + ' ' + z);
                        }

                    });
                } else {
                    $('#createnewexamens').attr('data-listechampsid', null);
                    $('#createnewexamens').attr('data-idte', null);
                    $('#createnewexamens').attr('data-matriculepatient', null);
                    $('#patientrequis').show();
                    $("#te").val("");
                    $("#resultsection").children("div").remove();
                }
            } else {
                $("#resultsection").children("div").remove();
            }
        });

        {#console.log('path')#}
        {#console.log('{{ path('index') }}')#}
        {#console.log("{{ app.request.attributes.get('_route') }}")#}
        if ('{{ app.request.attributes.get('_route') }}' === 'index') {

            $.ajax({
                url: "{{ path('apiconsultation') }}",
                data: {
                    action: "getstat"
                },
                type: "get",
                dataType: "json",
                success: function (data) {
                    if (data[0].labo) {
                        Morris.Line({
                            element: 'morris-area-chart-consultation',
                            data: data,
                            xkey: 'period',
                            ykeys: ['examen'],
                            labels: ['examen'],
                            pointSize: 4,
                            hideHover: 'auto',
                            resize: true
                        });
                    } else {
                        Morris.Line({
                            element: 'morris-area-chart-consultation',
                            data: data,
                            xkey: 'period',
                            ykeys: ['consultation'],
                            labels: ['consultation'],
                            pointSize: 4,
                            hideHover: 'auto',
                            resize: true
                        });
                    }
                },
                error: function (x, y, z) {
                    alert(x + ' ' + y + ' ' + z);
                }

            });
        }

        $('#nbjrrepos').mask('999');
        $('#telpatient').mask('99-999-99-99');
        $("#selectstruc").select2({
            theme: "bootstrap"
        });


        if (window.location.href.includes('examen/new/consultation=') || window.location.href.includes('examen/edit/')) {

            var bttn = $('#createexamens').closest('button');
            var idte = $(bttn).attr('data-idte');
            var idconsult = $(bttn).attr('data-idconsult');
            console.log(idte, idconsult);

            // var medicSelected = $("#medicSelected").val();
            var urlexamen = "{{ path('examen_new1', {consultationid: 0, typeexamenid: 2}) }}";
            var url0 = urlexamen.replace("2", idte);
            var url1 = url0.replace("0", idconsult);
            $.ajax({
                url: url1,
                type: "GET",
                data: {},
                dataType: 'json',
                success: function (data) {
                    $.each(data.champsTE, function (item, value) {
                        if (value.valeurminf == null) {
                            $('#sectionResultat')
                                .append(`
                                <div class="form-group col-md-6">
                                    <label for="${value.id}"> ${value.libelle} </label>
                                    <input required="true" type="text" class="form-control" id="${value.id}"
                                    placeholder="${value.valeurmin} <> ${value.valeurmax} (${value.unite}) ">
                                </div>
                            `)
                        } else {
                            $('#sectionResultat')
                                .append(`
                                <div class="form-group col-md-6">
                                    <label for="${value.id}"> ${value.libelle} </label>
                                    <input required="true" type="text" class="form-control" id="${value.id}"
                                    placeholder="Homme ${value.valeurmin} <> ${value.valeurmax} (${value.unite})
                                    Femme ${value.valeurminf} <> ${value.valeurmaxf} (${value.unite})">
                                </div>
                            `)
                        }


                        $('body').on('click', '#createexamens', function (event) {

                            var resultat = $('#' + value.id).val();
                            if (resultat !== '') {

                                // pour l'ajout

                                var urlajoutexam = "{{ path('examen_new', {consultationid: 2, typeexamenid: 0}) }}";
                                var urlte = urlajoutexam.replace("0", idte);
                                var urlexamajout = urlte.replace("2", idconsult);
                                var datepre = $('#datepre').val();
                                console.log(datepre)
                                $.ajax({
                                    url: urlexamajout,
                                    type: "POST",
                                    data: {
                                        idconsult: idconsult,
                                        action: 'new',
                                        idte: idte,
                                        resultat: resultat,
                                        champid: value.id,
                                        datepre: datepre
                                    },
                                    dataType: 'json',
                                    success: function (data) {
                                        console.log(data.output)
                                        var goto = "{{ path('examen_show', {id:0}) }}";
                                        window.location.href = goto.replace('0', data.output);
                                    },
                                    error: function (x, y, z) {
                                        alert(x + ' ' + y + ' ' + z);
                                    }
                                });


                            }
                        });

                    });


                },
                error: function (x, y, z) {
                    alert(x + ' ' + y + ' ' + z);
                }
            });

        }


        $('#createexams').click(function () {
            var bttn = $('#createexams').closest('button');
            var idconsult = $(bttn).attr('data-idconsult');
            var datepre = $('#datepre').val();
            var urlexamen = "{{ path('createexams', {numeroconsult: 0}) }}";
            var url1 = urlexamen.replace("0", idconsult);
            var ok = true;
            $('.resultattoAdd').each(function (i) {
                if (!$(this).val()) {
                    ok = false;
                }
            });

            if (ok) {
                $('.resultattoAdd').each(function (i) {
                    if ($(this).val() !== '') {
                        $.ajax({
                            url: url1,
                            type: "POST",
                            data: {
                                idconsult: idconsult,
                                action: 'new',
                                idte: $(this).attr('id-te'),
                                resultat: $(this).val(),
                                champid: $(this).attr('id'),
                                datepre: datepre
                            },
                            dataType: 'json',
                            success: function (data) {
                                var goto = "{{ path('examen_show_all', {id:0}) }}";
                                window.location.href = goto.replace('0', data.output);
                            },
                            error: function (x, y, z) {
                                alert(x + ' ' + y + ' ' + z);
                            }
                        });
                    }
                });
            } else {
                $('#alert-new-exam').show();
                $('#alert-new-exam').empty();
                $('#alert-new-exam').append('veuillez remplir tous les champs');
                setTimeout(function () {
                    $('#alert-new-exam').fadeOut('slow');
                    $('#alert-new-exam').empty();
                }, 4000)
            }


        });

//        UPDATE RESULTAT EXAMEN
        $('.updateResult').click(function (event) {
            event.preventDefault();
            let btneditresult = $(event.target).closest('button');
            let p = $(event.target).closest('p')
            let libelletoedit = $(btneditresult).attr('data-libelle');
            let restoedit = $(btneditresult).attr('data-res');
            let chtypeexamtoedit = $(btneditresult).attr('data-chtypeex');
            let idconsult = $(btneditresult).attr('data-idconsult');
            let idte = $(btneditresult).attr('data-idte');
            console.log(chtypeexamtoedit)
            console.log(idconsult)
            console.log(idte)
            p.hide();
            let url = "{{ path('oneresultexamen', {idconsult:'aaaa', idresult:'bbbb', idte:'cccc'}) }}";
            let ur = url.replace("aaaa", idconsult);
            let u = ur.replace("bbbb", chtypeexamtoedit);
            let l = u.replace("cccc", idte);
            console.log(l)
            $.ajax({
                url: l,
                type: "get",
                data: {},
                dataType: 'json',
                success: function (data) {
                    console.log(data)
                    let sectionresult = $('#sectionresult');
                    sectionresult.append(`
                       <p>
                        <label> ${data.libelle} </label>
                        <input required="true" type="text" class="" value="${ data.resultat }" id="id${data.id}">
                        <button data-idexam="${data.id}" class="createupdateResult btn btn-success btn-outline btn-xs pull-right"><i class="fa fa-save"></i></button>
                       </p>
            `);
                },
                error: function (x, y, z) {
                    alert(x + ' ' + y + ' ' + z);
                }
            });
        })

        //      CREATE UPDATE RESULTAT EXAMEN
        $('body').on('click', '.createupdateResult', function (event) {
            event.preventDefault();
            let btneditresult = $(event.target).closest('button');
            let idexamtoedit = $(btneditresult).attr('data-idexam');
            let url = "{{ path('examen_edit', {id:0}) }}";
            let ur = url.replace("0", idexamtoedit);
            let value = $("#id" + idexamtoedit).val();
            console.log(value)
            $.ajax({
                url: ur,
                type: "POST",
                data: {
                    id: idexamtoedit,
                    value: value,
                    action: 'update'
                },
                dataType: 'json',
                success: function (data) {
                    if (data.output === 'ok') {
                        location.reload();
                    }
                },
                error: function (x, y, z) {
                    alert(x + ' ' + y + ' ' + z);
                }
            });
        })


        $('#alert-new-exam').hide();
        $('#createnewexamens').click(function (e) {
            e.preventDefault();
            var idte = $('#createnewexamens').attr('data-idte')
            var matriculepatient = $('#createnewexamens').attr('data-matriculepatient')
            if (idte !== null || matriculepatient != null) {

                // pour l'ajout
                var urlajoutexam = "{{ path('examen_new', {consultationid: 0, typeexamenid: 111}) }}";
                var urlexamajout = urlajoutexam.replace(111, idte);
                var datepre = $('#datepre').val();
                var ok = true;
                $('#resultsection input').each(function (i) {
                    // console.log(!$(this).val())
                    if (!$(this).val()) {
                        ok = false;
                        $('#alert-new-exam').show();
                        $('#alert-new-exam').empty();
                        $('#alert-new-exam').append('veuillez remplir tous les champs');
                        setTimeout(function () {
                            $('#alert-new-exam').fadeOut('slow');
                            $('#alert-new-exam').empty();
                        }, 4000)
                    }
                });

                if (ok) {
                    $('#resultsection input').each(function (i) {
                        if ($(this).val() !== '') {
                            $.ajax({
                                url: urlexamajout,
                                type: "POST",
                                data: {
                                    idconsult: 0,
                                    action: 'new',
                                    matriculepatient: matriculepatient,
                                    idte: idte,
                                    resultat: $(this).val(),
                                    champid: $(this).attr('id'),
                                    datepre: datepre
                                },
                                dataType: 'json',
                                success: function (data) {
                                    var goto = "{{ path('examen_show', {id:0}) }}";
                                    window.location.href = goto.replace('0', data.output);
                                },
                                error: function (x, y, z) {
                                    alert(x + ' ' + y + ' ' + z);
                                }
                            });
                        }
                    });
                }


            }
        })


        $('.approuver').click(function ($event) {
//            console.log($(this))
//            console.log($('.approuver').closest('button'))
            var bttn = $(this);
            var idconsult = $(bttn).attr('data-idconsult');
            var urlexamen = "{{ path('examen_approuver', {numeroconsult: 0}) }}";
            var url1 = urlexamen.replace("0", idconsult);

            $.ajax({
                url: url1,
                type: 'POST',
                data: {},
                dataType: 'json',
                success: function (data) {
                    console.log(data)
                    if (data.output === 'ok') {
                        location.reload();
                    }

                },
                error: function (x, y, z) {
                    alert(x + ' ' + y + ' ' + z);
                }

            });

        })

        $('.desapprouver').click(function ($event) {
            var bttn = $(this);
            var idconsult = $(bttn).attr('data-idconsult');
            var urlexamen = "{{ path('examen_desapprouver', {numeroconsult: 0}) }}";
            var url1 = urlexamen.replace("0", idconsult);

            $.ajax({
                url: url1,
                type: 'POST',
                data: {},
                dataType: 'json',
                success: function (data) {
                    if (data.output === 'ok') {
                        location.reload();
                    }
                },
                error: function (x, y, z) {
                    alert(x + ' ' + y + ' ' + z);
                }

            });

        });
    });
</script>
</body>

</html>

